# é¢˜ç›®ï¼š React æ¶æ„è®¾è®¡ï¼šä» stack reconciler åˆ° fiber reconciler çš„æ¼”è¿›

# å‰è¨€

React ä» 2013 å¹´å¼€æºè‡³ä»Šï¼Œç»è¿‡äº†å¤šä¸ªç‰ˆæœ¬çš„è¿­ä»£ï¼Œè€Œ React16 ç‰ˆæœ¬åˆ™æ˜¯å…¶ä¸­ä¸€ä¸ªé‡Œç¨‹ç¢‘å¼çš„ç‰ˆæœ¬ï¼Œå› å…¶å¼€å¯äº†ä» stack reconciler åˆ° fiber reconciler çš„è½¬å˜å†ç¨‹ã€‚
æ—¶è‡³ä»Šæ—¥çš„ React19ï¼ŒFiber æ¶æ„ä»æ˜¯åº•å±‚æ¶æ„ã€‚åœ¨è¿‘äº›ç‰ˆæœ¬çš„è¿­ä»£ä¸­ï¼ŒReact åŸºäº Fiber æ¶æ„ä¸°å¯Œäº†å¹¶å‘æ¨¡å¼çš„å„ç§å®ç°ï¼Œç”±æ­¤å¯è§ Fiber æ¶æ„çš„é‡è¦æ€§ã€‚

æœ¬æ–‡å°†ä¼šåˆ†äº« React16 ä¹‹å‰ stack reconciler çš„ç‰¹ç‚¹ï¼Œä»¥åŠå…¶å­˜åœ¨çš„éšæ‚£ï¼Œä»è€Œå¼•å‡º React å›¢é˜Ÿå¯¹ Fiber æ¶æ„çš„è®¾è®¡åŠå¦‚ä½•ä½¿ç”¨ fiber reconciler è¿›è¡Œæ¸²æŸ“ä¼˜åŒ–ã€‚

# React æ›´æ–°é¡µé¢çš„åŸºæœ¬æµç¨‹

åœ¨æ­£å¼å¼€å§‹ä»‹ç» stack reconciler å’Œ fiber reconciler ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ React æ›´æ–°é¡µé¢çš„åŸºæœ¬æµç¨‹ã€‚

æ— è®ºæ˜¯åœ¨ React16 ä¹‹å‰ï¼Œæˆ–æ˜¯ä¹‹åï¼ŒReact åœ¨è¿›è¡Œé¡µé¢æ›´æ–°æ—¶ï¼Œéƒ½å¯ä»¥å®è§‚åœ°åˆ†è§£ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«æ˜¯ï¼š

- Render / Reconciliation é˜¶æ®µï¼šåˆç§°åè°ƒé˜¶æ®µï¼Œæ˜¯ React åœ¨å†…å­˜ä¸­æ„å»ºè™šæ‹Ÿ DOM æ ‘çš„é˜¶æ®µã€‚æ­¤é˜¶æ®µçš„æ ¸å¿ƒä¸º Reconcilerï¼ˆåè°ƒå™¨ï¼‰ã€‚
- Commit é˜¶æ®µï¼šåˆç§°æäº¤é˜¶æ®µï¼Œæ˜¯ React æ ¹æ®è™šæ‹Ÿ DOM æ ‘ï¼Œå°†è¦ä¿®æ”¹çš„åœ°æ–¹ä¸€æ¬¡æ€§æäº¤åˆ°çœŸå® DOM ä¸Šçš„é˜¶æ®µã€‚æ­¤é˜¶æ®µçš„æ ¸å¿ƒä¸º Rendererï¼ˆæ¸²æŸ“å™¨ï¼‰ã€‚

# stack reconciler ä¸ fiber reconciler çš„å‰ä¸–ä»Šç”Ÿ

## stack reconciler ç‰¹ç‚¹åŠå±€é™æ€§

åœ¨ React16 ä¹‹å‰ï¼Œå½“åº”ç”¨çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œå®è§‚ä¸Šä¼šæ‰§è¡Œä»¥ä¸‹ä¸¤éƒ¨åˆ†çš„å·¥ä½œï¼Œä»¥æ›´æ–° UIï¼š

1. Reconcilerï¼ˆåè°ƒå™¨ï¼‰ä¼šç”Ÿæˆæ–°çš„è™šæ‹Ÿ DOMï¼Œå¹¶ä¸æ—§çš„è™šæ‹Ÿ DOM è¿›è¡Œå¯¹æ¯”ï¼Œæ‰¾å‡ºéœ€è¦æ›´æ–°çš„éƒ¨åˆ†ã€‚
2. Rendererï¼ˆæ¸²æŸ“å™¨ï¼‰æ ¹æ® Reconciler è®¡ç®—çš„ç»“æœï¼Œå°†éœ€è¦æ›´æ–°çš„éƒ¨åˆ†æäº¤åˆ°çœŸå® DOM ä¸Šã€‚

Reconciler åœ¨å¤„ç†ç»„ä»¶æ ‘çš„æ›´æ–°æ—¶ï¼Œé‡‡ç”¨çš„æ˜¯é€’å½’çš„æ–¹å¼ï¼Œæ˜¯ä¸€ä¸ª`ä¸å¯ä¸­æ–­`çš„è¿‡ç¨‹ï¼ˆå³ stack reconcilerï¼‰ï¼Œè€Œ JS ä½œä¸ºå•çº¿ç¨‹è¯­è¨€ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ä¸èƒ½å¤„ç†å…¶ä»–ä»»åŠ¡ï¼ˆå¦‚å“åº”ç”¨æˆ·çš„è¾“å…¥æ“ä½œç­‰ï¼‰ã€‚è¿™å°±é€ æˆäº†åº”ç”¨äº¤äº’å¡é¡¿çš„é£é™©ï¼Œä¸”åœ¨é€’å½’çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦åˆ›å»ºå¤§é‡çš„è°ƒç”¨æ ˆï¼Œè¿™åœ¨å¤„ç†å¤§å‹ç»„ä»¶æ ‘çš„æ—¶å€™å¯èƒ½ä¼šå¯¼è‡´æ ˆæº¢å‡ºã€‚

> ä»¥ stack reconciler ä¸¾ä¸ª ğŸŒ°ï¼š\
> å½“åº”ç”¨è§¦å‘äº†çŠ¶æ€å˜æ›´ï¼Œéœ€è¦æ›´æ–° UIï¼Œå‡è®¾æœ¬æ¬¡æ›´æ–°éå¸¸å¤æ‚ï¼Œéœ€è¦è€—è´¹ 100msï¼Œé‚£ä¹ˆåœ¨è¿™ 100ms å†…ï¼Œå¦‚æœç”¨æˆ·è¿›è¡Œäº†å…¶ä»–æ“ä½œï¼Œå¦‚åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ–‡æœ¬ã€‚æŒ‰ç…§ stack reconciler çš„è®¾è®¡ï¼ŒReconciler çš„å·¥ä½œè¿‡ç¨‹ä¸å¯ä¸­æ–­ï¼Œå¿…é¡»ç­‰å¾…å‰ä¸€ä¸ªæ¸²æŸ“ä»»åŠ¡å®Œæˆåï¼Œæ‰èƒ½è¿›è¡Œåç»­çš„è¾“å…¥æ¡†å†…å®¹çš„å˜æ›´ã€‚è¿™å°±å¯¼è‡´äº†åº”ç”¨å¡é¡¿çš„æƒ…å†µã€‚

æ€»ç»“ä¸€ä¸‹ï¼ŒReact16 ä¹‹å‰çš„ Reconciler å­˜åœ¨çš„é—®é¢˜ï¼š

- é‡‡ç”¨é€’å½’æ–¹å¼å¤„ç†ç»„ä»¶æ ‘ï¼Œå¯èƒ½ä¼šå¯¼è‡´è°ƒç”¨æ ˆçš„æº¢å‡ºã€‚
- é€’å½’å¤„ç†ç»„ä»¶æ ‘çš„æ•´ä¸ªè¿‡ç¨‹æ˜¯ä¸å¯ä¸­æ–­çš„ï¼Œè¿™ä¼šé˜»å¡ç”¨æˆ·çš„äº¤äº’æˆ–å…¶ä»–é‡è¦çš„ä»»åŠ¡ã€‚
- æ›´æ–°ä»»åŠ¡æ²¡æœ‰ä¼˜å…ˆçº§çš„æ¦‚å¿µï¼Œæ— æ³•åŒºåˆ†é‡è¦ä»»åŠ¡ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥åçš„é¡µé¢æ¸²æŸ“ï¼‰ä¸æ™®é€šä»»åŠ¡ï¼ˆå¦‚æ•°æ®è¯·æ±‚åçš„é¡µé¢æ¸²æŸ“ï¼‰ï¼Œæ— æ³•è°ƒåº¦å®ƒä»¬çš„æ‰§è¡Œé¡ºåºï¼Œæ™®é€šä»»åŠ¡å¯èƒ½ä¼šé˜»å¡é‡è¦ä»»åŠ¡çš„æ‰§è¡Œã€‚

> æ³¨æ„ï¼š
> React16 ä¹‹å‰é¡µé¢æ›´æ–°çš„ä¸»è¦ç“¶é¢ˆæ˜¯å‘ç”Ÿåœ¨ Render é˜¶æ®µï¼Œå³ stack reconciler çš„è®¾è®¡ä¸Šã€‚
> è€Œ Commit é˜¶æ®µæ›´æ–°çœŸå® DOM çš„è¿‡ç¨‹å¹¶ä¸å­˜åœ¨æ˜æ˜¾çš„ç¼ºé™·ï¼Œæ‰€ä»¥ React16 çš„ä¼˜åŒ–ç‚¹ä¸»è¦é›†ä¸­åœ¨ reconciler çš„å®ç°æ–¹å¼ä¸Šã€‚

## fiber reconciler è®¾è®¡ä¸ä¼˜åŒ–ç‚¹

ä¸ºæ­¤ React å›¢é˜Ÿè®¡åˆ’åœ¨ React16 ä¸­é‡æ„ Reconciler çš„é€»è¾‘ï¼Œä»¥å®ç°åº”ç”¨åœ¨ Reconciler å·¥ä½œæ—¶èƒ½`ä¸­æ–­ä»»åŠ¡å¹¶ä¼˜å…ˆå¤„ç†ä¼˜å…ˆçº§è¾ƒé«˜çš„ä»»åŠ¡`ï¼Œå¦‚ç”¨æˆ·äº¤äº’æ“ä½œã€‚å¹¶å°†è¿™ä¸ªæ–°çš„æ–¹å¼ç§°ä¸º Fiber Reconcilerã€‚ï¼ˆè€Œ Commit é˜¶æ®µçš„ Renderer çš„å·¥ä½œé€»è¾‘ä¸å˜ï¼Œå…¶æ‰§è¡Œè¿‡ç¨‹ä»ç„¶æ˜¯ä¸å¯ä¸­æ–­çš„ï¼‰ã€‚

> ä»¥ fiber reconciler ä¸¾ä¸ª ğŸŒ°ï¼š\
> å¯¹äºä¸Šè¿°è€—æ—¶ 100ms çš„æ›´æ–°è€Œè¨€ï¼Œå½“ Reconciler å·¥ä½œåˆ°ä¸€åŠæ—¶ï¼Œç”¨æˆ·çªç„¶åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ–‡æœ¬ï¼Œé‚£ä¹ˆå¯¹äºè¿™ç§ç”±äºç”¨æˆ·æ“ä½œè€Œé€ æˆçš„çŠ¶æ€å˜æ›´ï¼Œåœ¨ React ä¸­å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ã€‚React ä¼šæš‚åœå½“å‰ Reconciler çš„å·¥ä½œï¼Œè½¬è€Œå»å¤„ç†ä¼˜å…ˆçº§æ›´é«˜çš„ç”¨æˆ·è¾“å…¥äº‹ä»¶ï¼Œå°†æ–‡æœ¬æ¸²æŸ“å‡ºæ¥ï¼Œç„¶åå†å›å»å¤„ç†åˆšæ‰ä¸­æ–­çš„ä»»åŠ¡ã€‚ç«™åœ¨ç”¨æˆ·çš„è§’åº¦ï¼Œé‚£ä¸ª 100ms çš„æ¸²æŸ“ç¡®å®æ˜¯è€—æ—¶è¾ƒé•¿ï¼Œä½†æ•´ä¸ª react åº”ç”¨åœ¨æ­¤è¿‡ç¨‹æ²¡æœ‰å¡é¡¿çš„æƒ…å†µå‡ºç°ï¼Œæ—¶åˆ»èƒ½å“åº”ç”¨æˆ·çš„æ“ä½œã€‚

> ç®€è€Œè¨€ä¹‹ï¼šFiber æ¶æ„`ä¸æ˜¯è®©æ¸²æŸ“å˜å¿«`ï¼Œè€Œæ˜¯è®©`å…³é”®ä»»åŠ¡æ°¸ä¸ç­‰å¾…`ã€‚

ä¸ºäº†å®ç° Render é˜¶æ®µå¯ä¸­æ–­ï¼ŒFiber æ¶æ„æ¯”å¯¹ä¹‹å‰çš„æ¶æ„åšå‡ºäº†å¦‚ä¸‹é‡å¤§æ”¹å˜ï¼š

- å°† stack reconciler ä¸­ä¸€æ•´ä¸ªæ¸²æŸ“ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªä»»åŠ¡ï¼Œä¸ºæ¸²æŸ“è¿‡ç¨‹çš„å¯ä¸­æ–­æä¾›äº†å¯èƒ½æ€§ã€‚

- å®ç°æ¸²æŸ“ä»»åŠ¡çš„å¯ä¸­æ–­ä¸å¯æ¢å¤ï¼Œåœ¨æ‰§è¡ŒæŸä¸ªæ¸²æŸ“ä»»åŠ¡æ—¶ï¼Œå¦‚æœåº”ç”¨è§¦å‘äº†ä¼˜å…ˆçº§æ›´é«˜çš„ä»»åŠ¡ï¼Œåˆ™å¯æš‚åœå½“å‰ä»»åŠ¡ï¼Œä¼˜å…ˆå¤„ç†é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œç„¶åå›æ¥æ¢å¤ä¹‹å‰çš„ä»»åŠ¡ã€‚

- å¼•å…¥ä¼˜å…ˆçº§è°ƒåº¦ç³»ç»Ÿï¼Œä¸åŒç±»å‹çš„æ›´æ–°ä»»åŠ¡æœ‰ä¸åŒä¼˜å…ˆçº§ï¼Œè°ƒåº¦ç³»ç»Ÿè‡ªåŠ¨å†³å®šä»»åŠ¡æ‰§è¡Œçš„å…ˆåé¡ºåºã€‚

æ¥ä¸‹æ¥å°†åˆ†æ Fiber æ¶æ„å¦‚ä½•ä¸ºå¯ä¸­æ–­æ¸²æŸ“çš„ fiber reconciler æä¾›æ•°æ®ç»“æ„å±‚é¢çš„æ”¯æŒï¼Œä¸»è¦ä½“ç°åœ¨å¦‚ä¸‹ä¸¤ç‚¹ï¼š

- ä½¿ç”¨ Fiber èŠ‚ç‚¹è®°å½•æ›´å¤šçš„ä¿¡æ¯ï¼Œå¹¶å¯ä½œä¸ºæ•´ä¸ªæ›´æ–°ä»»åŠ¡çš„å·¥ä½œå•å…ƒä½¿ç”¨ã€‚
- ä»¥ Fiber èŠ‚ç‚¹ç»„æˆçš„é“¾å¼æ ‘çŠ¶ç»“æ„æ›¿ä»£åŸæ¥çš„æ™®é€šæ ‘çŠ¶ç»“æ„ï¼Œä¸ºå¯ç»ˆç«¯éå†æä¾›å¯èƒ½æ€§ã€‚

# Fiber èŠ‚ç‚¹ ä¸ Fiber æ ‘

Fiber åŒ…å«ä¸‰å±‚å«ä¹‰ï¼š

- ä½œä¸ºæ•°æ®ç»“æ„æ¥è¯´ï¼Œä¸€ä¸ª Fiber èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ª React å…ƒç´ ï¼ˆReact ç»„ä»¶ã€åŸç”Ÿæ ‡ç­¾ç­‰ï¼‰ï¼Œä¿å­˜äº†è¯¥å…ƒç´ çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä½œä¸ºè™šæ‹Ÿ DOM çš„èŠ‚ç‚¹ä½¿ç”¨ã€‚è€Œ Fiber èŠ‚ç‚¹ç»„æˆçš„`é“¾å¼æ ‘çŠ¶ç»“æ„`å°±æ˜¯ Fiber æ¶æ„ä¸‹è™šæ‹Ÿ DOM çš„å®ç°æ–¹å¼ã€‚

- ä½œä¸ºæ¶æ„æ¥è¯´ï¼ŒReconciler çš„ç”Ÿæˆè™šæ‹Ÿ DOM çš„è¿‡ç¨‹æ˜¯åŸºäº Fiber èŠ‚ç‚¹å®ç°çš„å¯ä¸­æ–­éå†çš„è¿‡ç¨‹ï¼Œæ­¤è¿‡ç¨‹å¯ç§°ä¸º Fiber Reconcilerã€‚

- ä½œä¸ºå·¥ä½œå•å…ƒæ¥è¯´ï¼Œä¸€ä¸ª Fiber èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªå·¥ä½œå•å…ƒï¼Œä¿å­˜äº†æœ¬æ¬¡æ›´æ–°ä¸­è¯¥ç»„ä»¶æ”¹å˜çš„çŠ¶æ€ã€è¦æ‰§è¡Œçš„å·¥ä½œï¼ˆéœ€è¦è¢«åˆ é™¤/è¢«æ’å…¥é¡µé¢ä¸­/è¢«æ›´æ–°...ï¼‰ã€‚

ä¸ºäº†å®ç°ä¸å¯ä¸­æ–­çš„é€’å½’æ›´æ–°é‡æ„ä¸ºå¯ä¸­æ–­çš„éå†æ›´æ–°ï¼Œä¹‹å‰æ‰€ä½¿ç”¨çš„è™šæ‹Ÿ DOM æ ‘çš„å…ƒç´ æ•°æ®ç»“æ„å·²æ— æ³•æ»¡è¶³éœ€æ±‚ï¼ˆå› æ™®é€šæ ‘çŠ¶ç»“æ„æ— æ³•ä¸ä¾é å¤–ç•Œè€Œå®ç°é€’å½’ä¸­æ–­åçš„çŠ¶æ€è®°å½•ï¼‰ï¼Œéœ€è¦ Fiber èŠ‚ç‚¹æä¾›ç›¸å…³å±æ€§ä»¥æ”¯æŒé“¾å¼æ ‘çŠ¶ç»“æ„çš„æ­å»ºï¼Œä»¥ä¾¿åœ¨æŸä¸ªä»»åŠ¡ä¸­æ–­å¹¶æ¢å¤ä¹‹åï¼ŒReconciler çŸ¥é“ä¸‹ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡æ˜¯ä»€ä¹ˆã€‚

Fiber èŠ‚ç‚¹ä¸ç»“æ„ç›¸å…³çš„å±æ€§æœ‰å¦‚ä¸‹ä¸‰ä¸ªï¼š

- child: æŒ‡å‘å­ Fiber èŠ‚ç‚¹
- siblingï¼šæŒ‡å‘å³ä¾§ç¬¬ä¸€ä¸ªå…„å¼Ÿ Fiber èŠ‚ç‚¹
- returnï¼šæŒ‡å‘çˆ¶çº§ Fiber èŠ‚ç‚¹

ä¾é ä¸Šè¿°ä¸‰ä¸ªå±æ€§ï¼Œå°†å„ä¸ª Fiber èŠ‚ç‚¹è¿æ¥æˆé“¾å¼æ ‘çŠ¶ç»“æ„ã€‚å‡è®¾æœ‰å¦‚ä¸‹æ‰€ç¤ºçš„ React ç»„ä»¶

```
<App>
  <Header />
  <Main>
    <Component1 />
    <Component2 />
  </Main>
</APP>
```

å…¶ Fiber æ ‘ç»“æ„å¦‚å›¾æ‰€ç¤º

![fiberé“¾å¼æ ‘çŠ¶ç»“æ„](../assets/images/fiberé“¾å¼æ ‘çŠ¶ç»“æ„.png)

Fiber æ ‘çš„é“¾å¼æ ‘çŠ¶ç»“æ„çš„éå†ç‰¹ç‚¹ä¸ºï¼š

- æ·±åº¦ä¼˜å…ˆéå†
- å¤„ç†å½“å‰èŠ‚ç‚¹ï¼Œç„¶åå¯»æ‰¾ä¸‹ä¸€ä¸ªéœ€è¦å¤„ç†çš„èŠ‚ç‚¹
- ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å¯»æ‰¾é€»è¾‘ä¸ºï¼š
  - æœ‰ child èŠ‚ç‚¹åˆ™å¤„ç† child èŠ‚ç‚¹
  - æ—  child èŠ‚ç‚¹æˆ–å·²å¤„ç†å®Œæ¯•ï¼Œåˆ™å¤„ç† sibling èŠ‚ç‚¹
  - æ²¡æœ‰ sibling èŠ‚ç‚¹åˆ™å›å½’ return èŠ‚ç‚¹ï¼ˆreturn èŠ‚ç‚¹å¯»æ‰¾å…¶ sibling èŠ‚ç‚¹ï¼‰

æ¯ä¸ª Fiber èŠ‚ç‚¹éƒ½ä¿å­˜äº†ä»å“ªé‡Œæ¥ï¼Œè¯¥å¾€å“ªé‡Œå»çš„ä¿¡æ¯ï¼ˆå³ä½¿åœ¨æŸä¸ªèŠ‚ç‚¹å¤„ä¸­æ–­ä»»åŠ¡ï¼Œåç»­ä»å¯æ¢å¤éå†ï¼‰ï¼Œè¿™è®©å¯ä¸­æ–­éå†æä¾›äº†`ç»“æ„`ä¸Šçš„æ”¯æŒã€‚ï¼ˆå…·ä½“å¦‚ä½•å®ç°å¯ä¸­æ–­çš„é€»è¾‘ï¼Œéœ€è¦ä½¿ç”¨ Scheduler è¿›è¡Œè°ƒåº¦ï¼Œæœ¬æ–‡æš‚ä¸è®¨è®ºè¿™éƒ¨åˆ†çš„é€»è¾‘ï¼‰

# Fiber èŠ‚ç‚¹å…³é”®å±æ€§

æ¥ä¸‹æ¥ä»‹ç» Fiber èŠ‚ç‚¹ä¸­çš„ä¸€äº›å…³é”®å±æ€§ï¼Œå¹¶æŒ‰ç…§å…¶åŠŸèƒ½è¿›è¡Œåˆ†ç±»ä»‹ç»ã€‚

å¦‚ä¸‹èŠ‚é€‰äº†éƒ¨åˆ†æºç å®šä¹‰

```typeScript
export type Fiber = {
  // Tag identifying the type of fiber.
  tag: WorkTag,

  // Unique identifier of this child.
  key: null | string,

  // The value of element.type which is used to preserve the identity during
  // reconciliation of this child.
  elementType: any,

  // The resolved function/class/ associated with this fiber.
  type: any,

  // The local state associated with this fiber.
  stateNode: any,

  // The Fiber to return to after finishing processing this one.
  // This is effectively the parent, but there can be multiple parents (two)
  // so this is only the parent of the thing we're currently processing.
  // It is conceptually the same as the return address of a stack frame.
  return: Fiber | null,

  // Singly Linked List Tree Structure.
  child: Fiber | null,
  sibling: Fiber | null,

  // Input is the data coming into process this fiber. Arguments. Props.
  pendingProps: any, // This type will be more specific once we overload the tag.
  memoizedProps: any, // The props used to create the output.

  // A queue of state updates and callbacks.
  updateQueue: mixed,

  // The state used to create the output
  memoizedState: any,

  // Effect
  flags: Flags,
  subtreeFlags: Flags,
  deletions: Array<Fiber> | null,

  lanes: Lanes,
  childLanes: Lanes,

  // This is a pooled version of a Fiber. Every fiber that gets updated will
  // eventually have a pair. There are cases when we can clean up pairs to save
  // memory if we need to.
  alternate: Fiber | null,
};
```

## æ ‡è¯†å’Œç±»å‹å±æ€§

ä»¥ä¸‹å±æ€§ç”¨äºæ ‡è¯†æŸä¸ª Fiber èŠ‚ç‚¹çš„åŸºæœ¬ä¿¡æ¯åŠèº«ä»½æ ‡è¯†

### key

ä½œä¸ºå…ƒç´ çš„å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºä¼˜åŒ–å…ƒç´ å¯¹æ¯”è¿‡ç¨‹ã€‚

### tag

æ­¤å±æ€§æ ‡è¯†äº† Fiber èŠ‚ç‚¹çš„ç±»å‹ï¼Œè¿™ä¸ªæ ‡è®°ä¸ä»…ç”¨äºåŒºåˆ†ä¸åŒç±»å‹çš„èŠ‚ç‚¹ï¼Œæ›´é‡è¦çš„æ˜¯æŒ‡å¯¼ React å¦‚ä½•å¤„ç†è¿™ä¸ªèŠ‚ç‚¹ã€‚ä¸åŒç±»å‹çš„èŠ‚ç‚¹æœ‰ä¸åŒçš„å¤„ç†é€»è¾‘å’Œç”Ÿå‘½å‘¨æœŸã€‚

```typeScript
// tagå±æ€§çš„å€¼ä¸ºWorkTagç±»å‹
export type WorkTag = 0 | 1 | 2 | 3 |......

// FunctionComponent: 0,        // å‡½æ•°ç»„ä»¶
// ClassComponent: 1,           // ç±»ç»„ä»¶
// IndeterminateComponent: 2,   // æœªç¡®å®šç±»å‹çš„ç»„ä»¶
// HostRoot: 3,                 // æ ¹èŠ‚ç‚¹
// ......
```

### elementType & type

elementTypeï¼šåˆ›å»º Fiber æ—¶ä¼ å…¥çš„â€œåŸå§‹â€ç»„ä»¶ç±»å‹

typeï¼šå®é™…ç”¨äºæ¸²æŸ“çš„ç»„ä»¶çš„ç±»å‹

è¿™ä¸¤ä¸ªå±æ€§æ¯”è¾ƒå®¹æ˜“æ··æ·†ï¼Œåˆ—ä¸¾å¦‚ä¸‹ä¸‰ä¸ªä¾‹å­å¸®åŠ©ç†è§£ï¼š

ï¼ˆ1ï¼‰å¯¹äºåŸç”Ÿå…ƒç´ è€Œè¨€ï¼Œä¸¤è€…ç›¸åŒï¼Œå°±æ˜¯æ ‡ç­¾åç§°

```
<div>Hello</div>
// elementType â†’ 'div'
// type â†’ 'div'
```

ï¼ˆ2ï¼‰å¯¹äºæ™®é€šç»„ä»¶è€Œè¨€ï¼Œä¸¤è€…ç›¸åŒï¼ŒæŒ‡å‘ç»„ä»¶æœ¬èº«

```
function MyComponent() { return <div>Hello</div>; }
// elementType â†’ MyComponentï¼ˆå‡½æ•°ï¼‰
// type â†’ MyComponentï¼ˆå‡½æ•°ï¼‰
```

ï¼ˆ3ï¼‰å¯¹äºé«˜é˜¶ç»„ä»¶è¿”å›çš„ç»„ä»¶è€Œè¨€ï¼Œä¸¤è€…æœ‰æ˜æ˜¾åŒºåˆ«

å¯ç†è§£ä¸º type æ˜¯è§£åŒ…ä¹‹åçš„ç»„ä»¶ï¼ˆelementType.type === typeï¼‰

```
const Comp = React.memo(MyComponent);
// elementType â†’ Memo å¯¹è±¡ { type: MyComponent, ... }
// type â†’ MyComponentï¼ˆå‡½æ•°æœ¬èº«ï¼‰
```

## æ ‘çŠ¶ç»“æ„ç›¸å…³å±æ€§

Fiber èŠ‚ç‚¹é€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªå±æ€§å½¢æˆé“¾å¼æ ‘çŠ¶ç»“æ„

### return

æŒ‡å‘çˆ¶ Fiber èŠ‚ç‚¹

### child

æŒ‡å‘ç¬¬ä¸€ä¸ªå­ Fiber èŠ‚ç‚¹

### sibling

æŒ‡å‘ä¸‹ä¸€ä¸ªå…„å¼Ÿ Fiber èŠ‚ç‚¹

## çŠ¶æ€ç›¸å…³å±æ€§

å½“ React åº”ç”¨è¿›è¡Œé¡µé¢æ›´æ–°æ—¶ï¼Œæœ‰çš„ç»„ä»¶çš„ state æˆ– props ä¼šå‘ç”Ÿæ”¹å˜ï¼Œæœ‰çš„åˆ™ä¸å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦ä½¿ç”¨ç›¸å…³å±æ€§è®°å½•å®ƒä»¬çš„å€¼ï¼Œä»¥ä¾¿è¿›è¡Œæ•°æ®æ›´æ–°æˆ–è¿›è¡Œ memo ä¼˜åŒ–ã€‚

### memoizedProps

ä¸Šä¸€æ¬¡æ¸²æŸ“æ—¶ä½¿ç”¨çš„ props

### memoizedState

- ç±»ç»„ä»¶ï¼šä¿å­˜ä¸Šæ¬¡æ¸²æŸ“æ—¶ä½¿ç”¨çš„ state
- å‡½æ•°ç»„ä»¶ï¼šä¿å­˜ hooks é“¾è¡¨

### pendingProps

æ–°çš„å¾…å¤„ç†çš„ props

### updateQueue

- ç±»ç»„ä»¶ï¼šå­˜æ”¾ update å¯¹è±¡é“¾è¡¨
- å‡½æ•°ç»„ä»¶ï¼šå­˜æ”¾ effect å¯¹è±¡é“¾è¡¨ï¼ˆå‰¯ä½œç”¨é“¾è¡¨ï¼‰

## å‰¯ä½œç”¨ç›¸å…³å±æ€§

å¦‚ä¸‹å±æ€§æ ‡è®°äº†ä¸‹æ¬¡æ›´æ–°é¡µé¢æ—¶ï¼ŒæŸä¸ª Fiber èŠ‚ç‚¹éœ€è¦æ‰§è¡Œçš„å‰¯ä½œç”¨ç›¸å…³çš„ä¿¡æ¯

### flags

æ ‡è®°è¯¥ Fiber èŠ‚ç‚¹åœ¨ commit é˜¶æ®µéœ€è¦æ‰§è¡Œçš„å‰¯ä½œç”¨ï¼ˆå¦‚æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ç­‰ï¼‰ï¼Œå¯èƒ½å­˜åœ¨å¤šä¸ªå‰¯ä½œç”¨ã€‚

åœ¨ React ä¸­ï¼Œä½¿ç”¨äºŒè¿›åˆ¶æ•°å­—ä»£è¡¨ä¸åŒçš„å‰¯ä½œç”¨ï¼Œå¹¶ä½¿ç”¨`ä¸è¿ç®—`çš„ç»“æœè®°å½•æ‰€æœ‰å‰¯ä½œç”¨ã€‚

```javascript
export const NoFlags = /*                      */ 0b0000000000000000000000000000000;
export const PerformedWork = /*                */ 0b0000000000000000000000000000001;
export const Placement = /*                    */ 0b0000000000000000000000000000010;
export const Update = /*                       */ 0b0000000000000000000000000000100;
export const Cloned = /*                       */ 0b0000000000000000000000000001000;
export const ChildDeletion = /*                */ 0b0000000000000000000000000010000;
export const ContentReset = /*                 */ 0b0000000000000000000000000100000;
export const Callback = /*                     */ 0b0000000000000000000000001000000;
```

æ¯ä¸ªäºŒè¿›åˆ¶æ•°å­—ä»£è¡¨ä¸€ç§å‰¯ä½œç”¨ï¼Œä¸”æœ€å°å•ä½çš„å‰¯ä½œç”¨çš„äºŒè¿›åˆ¶æ•°å­—ä¸­åªåŒ…å«ä¸€ä¸ª 1ã€‚å¦‚æœæŸä¸ª Fiber èŠ‚ç‚¹éœ€è¦æ‰§è¡Œä¸¤ä¸ªå‰¯ä½œç”¨ï¼Œåˆ™å¯ä½¿ç”¨å®ƒä»¬å¯¹åº”çš„äºŒè¿›åˆ¶æ•°å­—è¿›è¡Œä¸è¿ç®—ï¼Œå¾—å‡ºæ‹¥æœ‰ä¸¤ä¸ª 1 çš„äºŒè¿›åˆ¶æ•°å­—ï¼Œå³å¯åæ¨å‡ºè¿™ä¸¤ä¸ªå‰¯ä½œç”¨æ˜¯ä»€ä¹ˆã€‚

å‡è®¾æŸä¸ª Fiber èŠ‚ç‚¹æ—¢éœ€è¦æ›´æ–°ï¼Œåˆéœ€è¦åˆ é™¤å­èŠ‚ç‚¹ï¼Œåˆ™å…¶ flags ä¼šè¿›è¡Œå¦‚ä¸‹è¿ç®—

```
// 0b0000000000000000000000000010100
fiber.flags = Update | ChildDeletion;

// 0b0000000000000000000000000000100 | 0b0000000000000000000000000010000 = 0b0000000000000000000000000010100
```

### subtreeFlags

å­æ ‘ä¸­çš„å‰¯ä½œç”¨æ ‡è®°ï¼Œè®°å½•å­å­™èŠ‚ç‚¹ä¸­æ˜¯å¦æœ‰å‰¯ä½œç”¨ï¼Œå¦‚æœ‰ï¼Œåˆ™å½“å‰èŠ‚ç‚¹çš„ subtreeFlags å°±ä¸ä¸º 0ã€‚

åœ¨ Commit é˜¶æ®µï¼ŒReact éœ€è¦éå† Fiber æ ‘ï¼Œæ‰¾å‡ºå“ªäº›èŠ‚ç‚¹æœ‰å‰¯ä½œç”¨ï¼ˆflags â‰  0ï¼‰å¹¶æ‰§è¡Œå®ƒä»¬ã€‚ä½†å¦‚æœæŸä¸ªèŠ‚ç‚¹çš„ subtreeFlags === 0ï¼Œè¯´æ˜å®ƒçš„æ•´ä¸ªå­æ ‘éƒ½æ²¡æœ‰å‰¯ä½œç”¨ï¼ŒReact å°±å¯ä»¥è·³è¿‡éå†å®ƒçš„æ‰€æœ‰å­å­™èŠ‚ç‚¹ï¼Œç›´æ¥â€œå‰ªæä¼˜åŒ–â€ï¼ŒèŠ‚çœå¤§é‡æ— æ„ä¹‰çš„éå†å¼€é”€ã€‚

### deletions

ä¿å­˜å½“å‰ Fiber èŠ‚ç‚¹çš„ç›´æ¥å­èŠ‚ç‚¹ä¸­éœ€è¦è¢«åˆ é™¤çš„èŠ‚ç‚¹ã€‚

åœ¨åè°ƒè¿‡ç¨‹ä¸­ï¼Œè¢«åˆ é™¤çš„èŠ‚ç‚¹å°±ä¼šä» Fiber æ ‘ä¸­ç§»é™¤ï¼Œæ— æ³•é€šè¿‡ Fiber æ ‘å¯»æ‰¾åˆ°ã€‚
ä½† Commit é˜¶æ®µä»éœ€è¦æ‰¾åˆ°å®ƒä»¬å¹¶æ‰§è¡Œæ¸…ç†æ“ä½œï¼ˆå¦‚ä» DOM ç§»é™¤ã€æ‰§è¡Œç”Ÿå‘½å‘¨æœŸé’©å­ /hooksï¼‰ã€‚
æ‰€ä»¥éœ€è¦ä½¿ç”¨ deletions å±æ€§ä¿å­˜è¿™äº›èŠ‚ç‚¹ã€‚

## åŒç¼“å†²æœºåˆ¶ç›¸å…³å±æ€§

Fiber æ¶æ„ä½¿ç”¨åŒç¼“å­˜æœºåˆ¶ä¼˜åŒ–é¡µé¢çš„æ¸²æŸ“è¿‡ç¨‹ï¼Œå³åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸¤é¢— Fiber æ ‘ï¼ˆcurrent fiber tree å’Œ workInProgress fiber treeï¼‰ï¼Œä»¥ä¾¿åœ¨å†…å­˜ä¸­è®¡ç®—ä¸‹æ¬¡æ›´æ–°æ‰€éœ€è¦è¿›è¡Œçš„ä¿®æ”¹ï¼Œå¹¶ä¸€æ¬¡æ€§æäº¤åˆ°çœŸå® DOM ä¸Šï¼Œä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ã€‚

> current fiber treeï¼šå½“å‰é¡µé¢æ‰€å¯¹åº”çš„è™šæ‹Ÿ DOM æ ‘\
> workInprogress fiber treeï¼šä¸‹æ¬¡è¦æ¸²æŸ“çš„é¡µé¢æ‰€å¯¹åº”çš„è™šæ‹Ÿ DOM æ ‘

### alternate

æŒ‡å‘å¦ä¸€ä¸ªæ ‘ä¸­å¯¹åº”çš„ Fiber èŠ‚ç‚¹
å³ current fiber tree å’Œ workInProgress fiber tree çš„äº’ç›¸å¼•ç”¨ï¼Œå®ç° fiber tree çš„å¿«é€Ÿåˆ‡æ¢ã€‚

```
fiber.alternate.alternate === fiber // true
```

## ä¼˜å…ˆçº§ç›¸å…³å±æ€§

åœ¨ React ä¸­ï¼Œä¸åŒäº‹ä»¶æ‰€è§¦å‘çš„é¡µé¢æ›´æ–°ä»»åŠ¡æ‹¥æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ï¼ŒReact æ ¹æ®ä¸åŒä»»åŠ¡çš„ä¼˜å…ˆçº§è°ƒåº¦å®ƒä»¬æ‰€æ‰§è¡Œçš„æ—¶æœºï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒã€‚

### lanes

è¡¨ç¤ºè¯¥ Fiber ä»»åŠ¡çš„ä¼˜å…ˆçº§ã€‚å€¼è¶Šå°ï¼Œä»£è¡¨ä¼˜å…ˆçº§è¶Šé«˜ã€‚
æ­¤å±æ€§çš„å€¼å’Œ flags ä¸€æ ·ï¼Œä¹Ÿæ˜¯äºŒè¿›åˆ¶æ•°å­—ã€‚

```javascript
export const SyncLane: Lane = /*                        */ 0b0000000000000000000000000000001;

export const InputContinuousHydrationLane: Lane = /*    */ 0b0000000000000000000000000000010;
export const InputContinuousLane: Lane = /*             */ 0b0000000000000000000000000000100;

export const DefaultHydrationLane: Lane = /*            */ 0b0000000000000000000000000001000;
```

### childLanes

è®°å½•äº†å½“å‰ Fiber èŠ‚ç‚¹çš„å­æ ‘ä¸­å­˜åœ¨çš„æ‰€æœ‰æ›´æ–°ä¼˜å…ˆçº§ï¼ˆlanesï¼‰

åœ¨ Render é˜¶æ®µï¼ŒReact ä¼šé€šè¿‡æ£€æŸ¥ childLanes å±æ€§æ¥åˆ¤æ–­å­æ ‘ä¸­æ˜¯å¦æœ‰æ›´æ–°ï¼Œå¦‚æœæ²¡æœ‰æ›´æ–°ï¼Œåˆ™è·³è¿‡å­æ ‘çš„éå†ã€‚

# æ€»ç»“

æœ¬æ–‡ä»‹ç»äº† React16 ä¹‹å‰çš„ stack reconciler æ˜¯é‡‡ç”¨é€’å½’çš„æ–¹å¼å»éå†ç»„ä»¶æ ‘ï¼Œä¸”æ­¤è¿‡ç¨‹ä¸å¯ä¸­æ–­ï¼Œæ— æ³•åŠæ—¶å“åº”å¦‚ç”¨æˆ·äº¤äº’ç­‰ä¼˜å…ˆçº§é«˜çš„ä»»åŠ¡ï¼Œå®¹æ˜“é€ æˆåº”ç”¨å¡é¡¿çš„ä½“éªŒã€‚

ä¸ºæ­¤ React16 é‡æ„äº† reconciler çš„å¤„ç†é€»è¾‘ï¼Œä»¥ä¾¿ React åº”ç”¨åœ¨è¿›è¡Œä»»åŠ¡å¤„ç†æ—¶ï¼Œèƒ½å®ç°ä¸­æ–­å¹¶åŠæ—¶å¤„ç†ä¼˜å…ˆçº§è¾ƒé«˜çš„ä»»åŠ¡ã€‚

ä¸ºäº†å®ç°ä¸Šè¿°ç›®æ ‡ï¼Œé‡‡ç”¨äº† Fiber æ¶æ„ï¼Œä»æ•°æ®ç»“æ„å±‚é¢ä¸Šä¸ºå¯ä¸­æ–­éå†æä¾›æ”¯æŒã€‚
